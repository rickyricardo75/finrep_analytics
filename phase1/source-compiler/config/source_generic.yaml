# =========================
# Source Compiler – Generic Config (Fixed)
# =========================

# --- Global read priorities
encoding_priority: ["utf-8", "cp1252", "latin1"]
delimiter_priority: [",", ";", "|", "\t"]
dayfirst_default: true
date_format_priority: ["%Y-%m-%d", "%d.%m.%Y", "%d/%m/%Y", "%m/%d/%Y", "%Y%m%d"]

# --- Defaults for specific readers (used only if a file does not override)
file_defaults:
  sheet: 0
  header_row: 0
  skiprows: []
  pdf_pages: "1"
  pdf_flavor: "lattice"

# --- Data quality thresholds
dq_thresholds:
  min_date_parse_rate: 0.90      # calendars must parse >=90% of dates
  min_required_coverage: 1.00

# --- Optional: tables to clear before each run (avoid duplicates)
truncate_before_load:
  - SRC_Holdings
  - SRC_Movements
  - SRC_DailyValues
  - SRC_CashAgenda
  - SRC_GenericCalendar

# --- Header alias map (raw header → canonical field)
header_aliases:
  # Core dates (keep valuation vs extraction distinct)
  value_date: ["valuation date", "value date", "as of", "asof", "pricing date", "date"]
  evaluation_date: ["evaluation date", "extract date", "extraction date", "run date", "report date"]

    # Portfolio / identifiers
  portfolio_nk: ["portfolio number", "portfolio_no", "portfolio id", "portfolio"]
  security_nk: ["isin", "security id", "security code", "instrument id"]
  position_id: ["position id", "position_no", "position number", "identification number"]
  security_name: ["description", "security name", "instrument", "name"]

  # Amounts / prices / currencies
  qty_raw: ["quantity", "qty", "quantity / amount", "amount"]
  price_raw: ["price", "unit price"]
  amount_raw: ["amount", "gross amount", "net amount", "cash amount", "quantity / amount"]
  native_ccy: ["currency", "trade currency", "ccy"]
  eval_ccy: ["currency", "eval ccy", "valuation currency"]

  # Movements (transaction / accounting)
  trade_id: ["transaction number", "tx id", "trade id", "operation id"]
  trade_date: ["purchase date", "trade date", "transaction date", "booking date"]
  settle_date: ["value date", "settlement date", "val date"]
  transaction_src: ["transaction", "tx type", "operation"]
  accounting_src: ["accounting", "gl", "ledger"]

 # CashAgenda-specific and shared fields (ADDITIVE)
  event_date: ["date"]                      # CashAgenda's "Date" → event_date
  amount_raw: ["quantity / amount"]         # maps "Quantity / Amount"
  cash_flow_type_src: ["type of cash flow", "cash flow type"]
  pre_tax_native: ["value pre-tax in trade currency"]
  pre_tax_eval: ["value pre-tax in evaluation currency"]
  after_tax_native: ["value after tax in trade currency"]

  # Calendars (CashAgendaCalendar already has explicit names)
  day: ["day"]
  month: ["month"]
  week: ["week", "week of year"]
  quarter: ["quarter"]
  year: ["year"]
  is_month_end: ["end of month"]
  is_year_end: ["end of year"]

# =========================
# FILES
# =========================
files:

  # ---- PORTFOLIO HOLDINGS (CSV)
  - name: Holdings
    file_type: csv
    path: "data/source/portfolio/Holdings.csv"
    target_table: "SRC_Holdings"
    delimiter: ";"
    encoding: [ "cp1252","utf-8" ]
    required: ["portfolio_nk"]                    # AND set
    required_any: [["value_date","evaluation_date"]]  # OR set (must have at least one)
    map:
      portfolio_nk: portfolio_nk
      value_date: value_date
      security_nk: security_nk
      position_id: position_id
      security_name: security_name
      qty_raw: qty_raw
      price_raw: price_raw
      native_ccy: native_ccy

  # ---- PORTFOLIO MOVEMENTS (CSV)
  - name: Movements
    file_type: csv
    path: "data/source/portfolio/Movements.csv"
    target_table: "SRC_Movements"
    delimiter: ";"
    encoding: [ "cp1252","utf-8" ]
    required: ["portfolio_nk"]
    required_any: [["trade_date","settle_date","value_date","evaluation_date"]]
    map:
      trade_id: trade_id
      portfolio_nk: portfolio_nk
      trade_date: trade_date
      settle_date: settle_date
      transaction_src: transaction_src
      accounting_src: accounting_src
      price_raw: price_raw
      amount_raw: amount_raw
      native_ccy: native_ccy

  # ---- DAILY VALUES (CSV)
  - name: DailyValues
    file_type: csv
    path: "data/source/performance/DailyValues.csv"
    target_table: "SRC_DailyValues"
    required: ["portfolio_nk"]
    required_any: [["value_date","evaluation_date"]]
    map:
      portfolio_nk: portfolio_nk
      value_date: value_date
      eval_ccy: eval_ccy
      value_end: value_end
      inflow: inflow
      outflow: outflow

  # ---- CASH AGENDA (CSV)
  - name: CashAgenda
    file_type: csv
    path: "data/source/performance/CashAgenda.csv"
    delimiter: ";"
    encoding: ["cp1252", "utf-8"]
    target_table: "SRC_CashAgenda"
    required: ["portfolio_nk"]
    required_any: [["value_date","evaluation_date"]]
    map:
      portfolio_nk: portfolio_nk
      event_date: event_date
      evaluation_date: evaluation_date
      native_ccy: native_ccy
      amount_raw: amount_raw
      security_nk: security_nk
      cash_flow_type_src: cash_flow_type_src
      pre_tax_native: pre_tax_native
      pre_tax_eval: pre_tax_eval
      after_tax_native: after_tax_native


  # ---- DAILY VALUES CALENDAR (single-column CSV: Date)
  - name: DailyValuesCalendar
    file_type: csv
    path: "data/source/calendars/DailyValuesCalendar.csv"
    target_table: "SRC_GenericCalendar"
    calendar: true
    # Deterministic read: one-column header 'Date'
    delimiter: ","
    encoding: "utf-8"
    force_single_date_column: true
    required_any: [["value_date","date"]]

  # ---- MOVEMENTS CALENDAR (single-column CSV: Date)
  - name: MovementsCalendar
    file_type: csv
    path: "data/source/calendars/MovementsCalendar.csv"
    target_table: "SRC_GenericCalendar"
    calendar: true
    delimiter: ","
    encoding: "utf-8"
    force_single_date_column: true
    required_any: [["value_date","date"]]

  # ---- CASH AGENDA CALENDAR (multi-column; semicolon-delimited)
  - name: CashAgendaCalendar
    file_type: csv
    path: "data/source/calendars/CashAgendaCalendar.csv"
    target_table: "SRC_GenericCalendar"
    calendar: true
    delimiter: ";"
    encoding: "utf-8"
    required_any: [["value_date","date"]]
